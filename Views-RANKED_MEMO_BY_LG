
CREATE VIEW RANKED_MEMO_BY_LG (DATECREATED,MEMO,RECORDID,TABLEID,USERNAME,LGID,LOCATIONGROUP,RANK,TABLENAME,REF) AS  
  WITH
	M
AS
(SELECT
	MEMO.DATECREATED,
	MEMO.MEMO,
	MEMO.RECORDID,
	MEMO.TABLEID,
	MEMO.USERNAME,
	LOCATIONGROUP.ID AS LGID,
	LOCATIONGROUP.NAME
FROM MEMO 
	 INNER JOIN SYSUSER ON MEMO.USERNAME = SYSUSER.USERNAME
	 INNER JOIN USERTOLG ON SYSUSER.ID = USERTOLG.USERID
	 INNER JOIN LOCATIONGROUP ON USERTOLG.LOCATIONGROUPID = LOCATIONGROUP.ID AND USERTOLG.DEFAULTFLAG = 1)
SELECT
	M.DATECREATED AS DATECREATED,
	M.MEMO AS MEMO,
	M.RECORDID AS RECORDID,
	M.TABLEID AS TABLEID,
	M.USERNAME AS USERNAME,
	M.LGID AS LGID,
	M.NAME AS LOCATIONGROUP,
	COUNT(M2.DATECREATED)+1 AS RANK,
	T.TABLEREFNAME AS TABLENAME,
	COALESCE(PO.NUM, PART.NUM, VENDOR.NAME, CUSTOMER.NAME) AS REF
FROM 
	M
	LEFT OUTER JOIN M AS M2 ON (M2.RECORDID = M.RECORDID AND M2.LGID = M.LGID AND M2.DATECREATED > M.DATECREATED)
	INNER JOIN TABLEREFERENCE AS T ON M.TABLEID = T.TABLEID
	LEFT OUTER JOIN PART ON (PART.ID = M.RECORDID AND M.TABLEID = -2003201472)
	LEFT OUTER JOIN PO ON (PO.ID = M.RECORDID AND M.TABLEID = 397076832)
	LEFT OUTER JOIN VENDOR ON (VENDOR.ID = M.RECORDID AND M.TABLEID = -850561568)
	LEFT OUTER JOIN CUSTOMER ON (CUSTOMER.ID = M.RECORDID AND M.TABLEID = 2142022944)
GROUP BY 1,2,3,4,5,6,7,9,10;

