
CREATE VIEW VW_POCOMINGQTY (DATEFIRSTSHIP,ID,POID,PARTID,CUSTOMERID,RUNNINGTOTAL) AS   WITH TEMP
AS
(
SELECT
	PO.DATEFIRSTSHIP,
	POITEM.ID,
	POITEM.POID,
	POITEM.PARTID,
	COALESCE(POITEM.CUSTOMERID,393) AS CUSTOMERID,
	(POITEM.QTYTOFULFILL - POITEM.QTYFULFILLED) AS QTYCOMING
FROM
	PO
	INNER JOIN POITEM ON PO.ID = POITEM.POID
WHERE
	POITEM.STATUSID < 31
	AND
	POITEM.TYPEID = 10
	AND
	POITEM.CUSTOMERID <> 393
	AND
	POITEM.CUSTOMERID IS NOT NULL
ORDER BY
	PARTID, CUSTOMERID, PO.DATEFIRSTSHIP
)
SELECT
	A.DATEFIRSTSHIP,
	A.ID,
	A.POID,
	A.PARTID,
	A.CUSTOMERID,
	SUM(B.QTYCOMING) AS CUSTOMERJOBRUNNINGTOTAL
FROM
	TEMP AS A
	LEFT OUTER JOIN TEMP AS B ON 
		A.PARTID = B.PARTID 
		AND
		A.CUSTOMERID = B.CUSTOMERID
		AND
		(A.DATEFIRSTSHIP > B.DATEFIRSTSHIP
		OR
		(A.DATEFIRSTSHIP = B.DATEFIRSTSHIP AND A.ID >= B.ID)
		)
GROUP BY
	A.DATEFIRSTSHIP,
	A.ID,
	A.POID,
	A.PARTID,
	A.CUSTOMERID	
ORDER BY
	A.PARTID, A.DATEFIRSTSHIP, CUSTOMERJOBRUNNINGTOTAL;

