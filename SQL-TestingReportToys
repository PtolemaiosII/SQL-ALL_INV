SELECT
	DISTINCT
	PRODUCT.NUM AS SKU,
	PRODUCT.DESCRIPTION,
	"COMPONENTTOPART".NUM AS TESTPART,
	CASE
	WHEN VW_TOYTESTING.TESTBOMID IS NULL THEN NULL
	ELSE 'ftp://files.pureandco.com/' || REPLACE("COMPONENTTOPART".NUM, ' ', '%20') || '/'
	END AS FTPPATH,
	VW_TOYTESTING.TESTNAME,
	VW_TOYTESTING.TESTDATE
FROM
	PRODUCT
	INNER JOIN PART ON PRODUCT.PARTID = PART.ID
	LEFT OUTER JOIN BOMITEM AS "SKU" ON "SKU".PARTID = PART.ID AND "SKU".TYPEID = 20
	LEFT OUTER JOIN BOM AS "SKUTOCOMPONENT" ON "SKUTOCOMPONENT".ID = "SKU".BOMID
	LEFT OUTER JOIN BOMITEM AS "COMPONENT" ON "COMPONENT".BOMID = "SKUTOCOMPONENT".ID AND "COMPONENT".TYPEID = 10
	LEFT OUTER JOIN BOMITEM AS "COMPONENT2" ON "COMPONENT".PARTID = "COMPONENT2".PARTID AND "COMPONENT2".TYPEID = 20
	LEFT OUTER JOIN BOM AS "COMPONENTTOPART" ON "COMPONENTTOPART".ID = "COMPONENT2".BOMID AND
		NOT EXISTS(
					SELECT
						BOM.NUM
					FROM
						BOM
						INNER JOIN CUSTOMINTEGER ON BOM.ID = CUSTOMINTEGER.RECORDID
						INNER JOIN CUSTOMFIELD ON CUSTOMINTEGER.CUSTOMFIELDID = CUSTOMFIELD.ID AND CUSTOMFIELD.TABLEID = 1705436292
					WHERE CUSTOMFIELD.ID IN (SELECT ID FROM GETINTEGERLIST('279')) AND BOM.ID = "COMPONENTTOPART".ID
					)
	LEFT OUTER JOIN VW_TOYTESTING ON "COMPONENTTOPART".ID = VW_TOYTESTING.TESTBOMID
WHERE
	PRODUCT.NUM LIKE '%342%'
	AND
	"COMPONENTTOPART".NUM LIKE 'TEST%'
ORDER BY
	PRODUCT.NUM,
	"COMPONENTTOPART".NUM,
	VW_TOYTESTING.TESTSORTORDER
