WITH TEMPPICK
AS
(
SELECT
	SO.NUM AS SONUM,
	SO.DATEFIRSTSHIP AS FULFILLMENTDATE,
	SOITEM.PRODUCTNUM AS SKU,
	SOITEM.QTYTOFULFILL AS QTYSOORDERED,
	SUM(COALESCE(PICKITEM.QTY, 0)) AS PICKQTY,
	(SOITEM.QTYTOFULFILL - SUM(COALESCE(PICKITEM.QTY, 0))) AS PICKINGSHORT,
	--MIN(VW_POCOMINGQTY.RUNNINGTOTAL) AS QTYPOORDERED,
	CUSTOMER.NAME AS CUSTOMER,
	CUSTOMER.ID AS CUSTOMERID,
	PART.ID AS PARTID
	--,
	--CASE
	--WHEN MIN(PICKITEM.STATUSID) BETWEEN 29 AND 41 THEN 'STOCK'
	--ELSE COALESCE(MIN(CAST(VW_POCOMINGQTY.DATEFIRSTSHIP AS DATE)),'***SHORT***')
	--END AS SOREADYDATE,
	--CASE
	--WHEN PICKITEM.STATUSID BETWEEN 29 AND 41 THEN 'IN STOCK'
	--WHEN CUSTOMINTEGER.INFO = 1 THEN 'PO CONFIRMED'
	--ELSE NULL
	--END AS STATUS
FROM
	SO
	INNER JOIN CUSTOMER ON SO.CUSTOMERID = CUSTOMER.ID
	INNER JOIN SOITEM ON SO.ID = SOITEM.SOID AND SOITEM.TYPEID = 10 AND SOITEM.STATUSID < 49
	LEFT OUTER JOIN PICKITEM ON PICKITEM.SOITEMID = SOITEM.ID AND PICKITEM.ORDERTYPEID = 20 AND PICKITEM.STATUSID BETWEEN 29 AND 41
	LEFT OUTER JOIN PRODUCT ON SOITEM.PRODUCTID = PRODUCT.ID
	LEFT OUTER JOIN PART ON PRODUCT.PARTID = PART.ID
	--AND VW_POCOMINGQTY.RUNNINGTOTAL >= SOITEM.QTYTOFULFILL
	--LEFT OUTER JOIN CUSTOMINTEGER ON VW_POCOMINGQTY.POID = CUSTOMINTEGER.RECORDID AND CUSTOMINTEGER.CUSTOMFIELDID = 354
WHERE
	SO.STATUSID BETWEEN 11 AND 54
	AND
	SOITEM.QTYTOFULFILL > 10
--	AND
--	SO.CUSTOMERID = (?)
GROUP BY
	SO.NUM,
	SO.DATEFIRSTSHIP,
	SOITEM.PRODUCTNUM,
	SOITEM.QTYTOFULFILL,
	CUSTOMER.NAME,
	CUSTOMER.ID,
	PART.ID
HAVING
	(SOITEM.QTYTOFULFILL - SUM(COALESCE(PICKITEM.QTY, 0))) > 0
ORDER BY
	PARTID, CUSTOMERID
),
TEMPQTYCOMMING
AS
(
SELECT
	PO.DATEFIRSTSHIP,
	POITEM.ID,
	POITEM.POID,
	POITEM.PARTID,
	COALESCE(POITEM.CUSTOMERID,393) AS CUSTOMERID,
	(POITEM.QTYTOFULFILL - POITEM.QTYFULFILLED) AS QTYCOMING
FROM
	PO
	INNER JOIN POITEM ON PO.ID = POITEM.POID
WHERE
	POITEM.STATUSID < 31
	AND
	POITEM.TYPEID = 10
	AND
	POITEM.CUSTOMERID <> 393
	AND
	POITEM.CUSTOMERID IS NOT NULL
ORDER BY
	PARTID, PO.DATEFIRSTSHIP, POID
)
SELECT
	*
FROM
	TEMPPICK
	LEFT OUTER JOIN TEMPQTYCOMMING ON TEMPQTYCOMMING.PARTID = TEMPPICK.PARTID AND TEMPPICK.CUSTOMERID = TEMPQTYCOMMING.CUSTOMERID AND TEMPQTYCOMMING.QTYCOMING = TEMPPICK.PICKINGSHORT
	LEFT OUTER JOIN VW_POCOMINGQTY ON VW_POCOMINGQTY.PARTID = TEMPPICK.PARTID AND TEMPPICK.CUSTOMERID = VW_POCOMINGQTY.CUSTOMERID AND VW_POCOMINGQTY.RUNNINGTOTAL >= TEMPPICK.PICKINGSHORT AND TEMPQTYCOMMING.ID IS NULL
