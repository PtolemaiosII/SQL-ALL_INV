
CREATE VIEW VW_POCOMINGQTYWITHMOQ (DATEFIRSTSHIP,ID,POID,PARTID,CUSTOMERID,RUNNINGTOTAL) AS    WITH TEMP
AS
(
SELECT
	PO.DATEFIRSTSHIP,
	POITEM.ID,
	POITEM.POID,
	POITEM.PARTID,
	COALESCE(POITEM.CUSTOMERID,393) AS CUSTOMERID,
	(POITEM.QTYTOFULFILL - POITEM.QTYFULFILLED) AS QTYCOMING
FROM
	PO
	INNER JOIN POITEM ON PO.ID = POITEM.POID
WHERE
	POITEM.STATUSID < 31
	AND
	POITEM.TYPEID = 10
	AND
	(
	POITEM.CUSTOMERID = 393
	OR
	POITEM.CUSTOMERID IS NULL
	)
ORDER BY
	PARTID, PO.DATEFIRSTSHIP
)
SELECT
	A.DATEFIRSTSHIP,
	A.ID,
	A.POID,
	A.PARTID,
	A.CUSTOMERID,
	--B.CUSTOMERID,
	--A.QTYCOMING,
	--B.QTYCOMING AS CUSTOMERJOBRUNNINGTOTAL
	SUM(B.QTYCOMING) AS CUSTOMERJOBRUNNINGTOTAL
FROM
	TEMP AS A
	LEFT OUTER JOIN TEMP AS B ON 
		A.PARTID = B.PARTID 
		AND
		(A.DATEFIRSTSHIP > B.DATEFIRSTSHIP
		OR
		(A.DATEFIRSTSHIP = B.DATEFIRSTSHIP AND A.ID >= B.ID)
		)
GROUP BY
	A.DATEFIRSTSHIP,
	A.ID,
	A.POID,
	A.PARTID,
	A.CUSTOMERID
ORDER BY
	A.PARTID, A.DATEFIRSTSHIP, CUSTOMERJOBRUNNINGTOTAL;

