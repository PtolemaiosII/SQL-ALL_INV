WITH
	TMP1
AS
(SELECT
	--SO.NUM,
	--PART.NUM,
	--SOITEM.QTYTOFULFILL,
	TB_M_LVL_BOM.BOMITEMTYPE_NAME,
	SUM(SOITEM.QTYTOFULFILL * TB_M_LVL_BOM.QTY) AS SUM_NEW_QTY,
	TB_M_LVL_BOM.LOW_P_ID,
	TB_M_LVL_BOM.LOW_P_NUM,
	TB_M_LVL_BOM.LOW_P_DEFAULTBOMID,
	TB_M_LVL_BOM.UOM_CODE
	--TB_M_LVL_BOM.QTY,
	--TB_M_LVL_BOM.MOTHER_BOM
FROM
	SO
	INNER JOIN SOITEM ON SO.ID = SOITEM.SOID
	INNER JOIN PRODUCT ON SOITEM.PRODUCTID = PRODUCT.ID
	INNER JOIN PART ON PRODUCT.PARTID = PART.ID
	INNER JOIN TB_M_LVL_BOM ON PART.DEFAULTBOMID = TB_M_LVL_BOM.MOTHER_BOM
WHERE
	--SO.NUM LIKE 'N58'
	--AND
	TB_M_LVL_BOM.LOW_P_NUM NOT LIKE 'BG%'
GROUP BY 1,3,4,5,6
)



SELECT
	--SONUM,
	BOMITEMTYPE_NAME,
	SUM_NEW_QTY,
	TMP1.LOW_P_NUM,
	TMP1.LOW_P_DEFAULTBOMID,
	UOM_CODE,
    TESTTABLE.QTY AS QTYONHAND,
	COALESCE(SUM(TRADEQTY),0) AS TRADEQTY
FROM
	TMP1
	INNER JOIN
    TESTTABLE ON TMP1.LOW_P_ID = TESTTABLE.ID
    LEFT OUTER JOIN TB_TRADEQTY ON (TB_TRADEQTY.ID IN (SELECT DISTINCT LOW_P_ID FROM TMP1 WHERE LOW_P_DEFAULTBOMID IS NOT NULL) AND TMP1.LOW_P_ID = TB_TRADEQTY.LOW_P_ID)
GROUP BY 1,2,3,4,5,6
