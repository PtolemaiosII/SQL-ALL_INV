SELECT
    ALL_PRO.PART_ID,
    ALL_PRO.PART_DEFAULTBOMID,
    ALL_PRO.PART_DESCRIPTION,
    ALL_PRO.PART_NUM,
    --ALL_PRO.SOITEM_QTYNEED,
    --ALL_PRO.UOM_CODE,
    ALL_PRO.SOITEM_QTYNEED,
    ALL_PRO.BACK_ORDER,
    M_LVL_BOM.BOM_ID,
    --M_LVL_BOM.BOM_NUM,
    --M_LVL_BOM.BOM_DESCRIPTION,
    --M_LVL_BOM.BOMITEM_ID,
    --M_LVL_BOM.BOMITEM_DESCRIPTION,
    COALESCE(M_LVL_BOM.BOMITEMTYPE_NAME, 'Unknown') AS BOMITEMTYPE_NAME,
    IIF(ALL_PRO.SOITEM_QTYNEED > ALL_PRO.BACK_ORDER, ALL_PRO.BACK_ORDER * COALESCE(M_LVL_BOM.QTY, 1), ALL_PRO.SOITEM_QTYNEED * COALESCE(M_LVL_BOM.QTY, 1)) AS QTY_CALLED,
    COALESCE(M_LVL_BOM.LOW_P_ID, PART_ID) AS LOW_P_ID,
    COALESCE(M_LVL_BOM.LOW_P_DESCRIPTION, PART_DESCRIPTION) AS LOW_P_DESCRIPTION,
    COALESCE(M_LVL_BOM.LOW_P_NUM, PART_NUM) AS LOW_P_NUM,
    COALESCE(M_LVL_BOM.UOM_CODE, ALL_PRO.UOM_CODE) AS LOW_P_UOM,
    M_LVL_BOM.LOW_P_DEFAULTBOMID,
    M_LVL_BOM.MOTHER_BOM,
    PR.REORDERPOINT AS MIN_QTY,
    PR.ORDERUPTOLEVEL AS MAX_QTY,
    VP.LEADTIME,
    COMPANY.NAME AS COMPANY
FROM
(SELECT
    -- SOITEMSTATUS."ID" AS SOITEMSTATUS_ID,
    -- SOITEMSTATUS."NAME" AS SOITEMSTATUS_NAME,
     SUM(SOITEM."QTYTOFULFILL" - SOITEM."QTYFULFILLED" - SOITEM."QTYPICKED") AS SOITEM_QTYNEED,
    -- SOSTATUS."ID" AS SOSTATUS_ID,
    -- SOSTATUS."NAME" AS SOSTATUS_NAME,
    --SO."NUM" AS SO_NUM,
     --SO."DATECREATED" AS SO_DATECREATED,
    -- SO."DATEFIRSTSHIP" AS SO_DATEFIRSTSHIP,
     UOM."CODE" AS UOM_CODE,
     PART."ID" AS PART_ID,
     PART."DEFAULTBOMID" AS PART_DEFAULTBOMID,
     PART."DESCRIPTION" AS PART_DESCRIPTION,
     PART."NUM" AS PART_NUM,
     --IIF(QTYATPTEST.BACK_ORDER > 0, QTYATPTEST.BACK_ORDER, 0) AS QTY_NEEDED,
     CHECK1.BACK_ORDER AS BACK_ORDER
     /*M_LVL_BOM.BOMITEMTYPE_NAME,
     M_LVL_BOM.LOW_P_ID,
     M_LVL_BOM.LOW_P_NUM,
     M_LVL_BOM.LOW_P_DESCRIPTION,
     M_LVL_BOM.MOTHER_BOM,
     QTYATPTEST.BACK_ORDER * M_LVL_BOM.QTY AS QTY*/
FROM
     "SO" SO INNER JOIN "SOITEM" SOITEM ON SO."ID" = SOITEM."SOID"
     --INNER JOIN "SOITEMSTATUS" SOITEMSTATUS ON SOITEM."STATUSID" = SOITEMSTATUS."ID"
     INNER JOIN "PRODUCT" PRODUCT ON SOITEM."PRODUCTID" = PRODUCT."ID"
     INNER JOIN "PART" PART ON PRODUCT."PARTID" = PART."ID"
     INNER JOIN "UOM" UOM ON PART."UOMID" = UOM."ID"
     --INNER JOIN "SOSTATUS" SOSTATUS ON SO."STATUSID" = SOSTATUS."ID"
     INNER JOIN CHECK1 ON PART.ID = CHECK1.PARTID AND CHECK1.BACK_ORDER > 0
WHERE
	SO."DATEISSUED" BETWEEN $P{dateRange1} AND $P{dateRange2}
	AND
	SO.STATUSID BETWEEN 10 AND 25
	AND
	SOITEM.STATUSID < 50
GROUP BY PART_ID, PART_DEFAULTBOMID, PART_NUM, PART_DESCRIPTION, BACK_ORDER, UOM_CODE) AS ALL_PRO
LEFT OUTER JOIN M_LVL_BOM ON ALL_PRO.PART_DEFAULTBOMID = M_LVL_BOM.MOTHER_BOM
LEFT OUTER JOIN
"PARTREORDER" AS PR ON LOW_P_ID = PR."PARTID" AND
PR.LOCATIONGROUPID = (
SELECT
     ADDRESS."LOCATIONGROUPID" AS ADDRESS_LOCATIONGROUPID
FROM
     "ACCOUNT" ACCOUNT INNER JOIN "ADDRESS" ADDRESS ON ACCOUNT."ID" = ADDRESS."ACCOUNTID"
     INNER JOIN "COMPANY" COMPANY ON ACCOUNT."ID" = COMPANY."ACCOUNTID"
WHERE
     COMPANY.ID = 1)
LEFT OUTER JOIN
"VENDORPARTS" AS VP ON LOW_P_ID = VP."PARTID"
JOIN company ON company.id = 1
ORDER BY BOMITEMTYPE_NAME, LOW_P_NUM
